<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Review - 492-Energy-Defense Security Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="logo">
                <h2>üõ°Ô∏è Energy Defense</h2>
                <p class="subtitle">Security Operations Center</p>
            </div>
            <nav class="nav-menu">
                <a href="/" class="nav-item">
                    <span class="nav-icon">üö®</span>
                    <span>Alerts & Anomalies</span>
                </a>
                <a href="/static/case-review.html" class="nav-item active">
                    <span class="nav-icon">üìã</span>
                    <span>Case Review</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <p class="small-text">492-Energy-Defense</p>
                <p class="small-text">v2.0.0</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1>Case Review</h1>
                <div class="header-actions">
                    <button class="btn btn-back" onclick="window.history.back()">‚Üê Back to Alerts</button>
                </div>
            </header>

            <!-- Case Details -->
            <section id="case-container" class="case-container">
                <div class="loading">Loading case details...</div>
            </section>
        </main>
    </div>

    <script>
        async function loadCaseDetails() {
            const params = new URLSearchParams(window.location.search);
            const alertId = params.get('id');

            if (!alertId) {
                await loadAllCases();
                return;
            }

            const container = document.getElementById('case-container');

            try {
                const response = await fetch(`/api/alert/${alertId}`);
                if (!response.ok) throw new Error('Alert not found');
                
                const alert = await response.json();
                container.innerHTML = '';
                container.appendChild(createCaseDetailView(alert));
            } catch (error) {
                console.error('Error loading case:', error);
                container.innerHTML = '<div class="error">Error loading case details. Please try again.</div>';
            }
        }

        async function loadAllCases() {
            const container = document.getElementById('case-container');

            try {
                const response = await fetch('/api/alerts?limit=20');
                const alerts = await response.json();

                if (alerts.length === 0) {
                    container.innerHTML = '<div class="no-data">No cases available for review</div>';
                    return;
                }

                container.innerHTML = '<h2>Recent Cases</h2>';
                const grid = document.createElement('div');
                grid.className = 'cases-grid';

                alerts.forEach(alert => {
                    const card = createCaseCard(alert);
                    grid.appendChild(card);
                });

                container.appendChild(grid);
            } catch (error) {
                console.error('Error loading cases:', error);
                container.innerHTML = '<div class="error">Error loading cases. Please try again.</div>';
            }
        }

        function createCaseCard(alert) {
            const card = document.createElement('div');
            card.className = `case-card severity-${alert.severity}`;
            
            const eventTypeIcon = {
                'login': 'üîê',
                'firewall': 'üî•',
                'patch': 'üõ°Ô∏è'
            };

            const timestamp = new Date(alert.analyzed_at);

            card.innerHTML = `
                <div class="case-card-header">
                    <span class="case-icon">${eventTypeIcon[alert.event_type]}</span>
                    <h3>Case #${alert.id}</h3>
                    <span class="badge badge-${alert.severity}">${alert.severity.toUpperCase()}</span>
                </div>
                <div class="case-card-body">
                    <p><strong>Type:</strong> ${alert.event_type}</p>
                    <p><strong>Risk Score:</strong> ${alert.risk_score}</p>
                    <p><strong>Date:</strong> ${timestamp.toLocaleString()}</p>
                </div>
                <button class="btn btn-primary" onclick="window.location.href='/static/case-review.html?id=${alert.id}'">
                    Review Case ‚Üí
                </button>
            `;

            return card;
        }

        function createCaseDetailView(alert) {
            const container = document.createElement('div');
            container.className = 'case-detail';

            const eventTypeIcon = {
                'login': 'üîê',
                'firewall': 'üî•',
                'patch': 'üõ°Ô∏è'
            };

            const timestamp = new Date(alert.analyzed_at);

            container.innerHTML = `
                <div class="case-header-large">
                    <div class="case-header-left">
                        <span class="case-icon-large">${eventTypeIcon[alert.event_type]}</span>
                        <div>
                            <h1>Case #${alert.id}</h1>
                            <p class="case-subtitle">${alert.event_type.toUpperCase()} Event Analysis</p>
                        </div>
                    </div>
                    <span class="badge-large badge-${alert.severity}">${alert.severity.toUpperCase()}</span>
                </div>

                <div class="case-metrics">
                    <div class="metric-card">
                        <div class="metric-value">${alert.risk_score}</div>
                        <div class="metric-label">Risk Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${alert.severity}</div>
                        <div class="metric-label">Severity Level</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${timestamp.toLocaleDateString()}</div>
                        <div class="metric-label">Date Analyzed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${timestamp.toLocaleTimeString()}</div>
                        <div class="metric-label">Time</div>
                    </div>
                </div>

                <div class="case-section">
                    <h2>üîç Analysis Summary</h2>
                    <div class="analysis-box">
                        ${alert.reasoning}
                    </div>
                </div>

                <div class="case-section">
                    <h2>‚ö° Recommended Action</h2>
                    <div class="action-box ${alert.severity === 'critical' || alert.severity === 'high' ? 'urgent' : ''}">
                        ${alert.recommended_action}
                    </div>
                </div>

                <div class="case-section">
                    <h2>üìä Event Details</h2>
                    ${formatDetailedEventInfo(alert.event_type, alert.event_details)}
                </div>

                <div class="case-section">
                    <h2>üìù Timeline</h2>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <strong>Event Occurred</strong>
                                <p>${alert.event_details.timestamp ? new Date(alert.event_details.timestamp).toLocaleString() : 'N/A'}</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <strong>Analyzed by AI Agent</strong>
                                <p>${timestamp.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <strong>Status</strong>
                                <p>Pending SOC Review</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return container;
        }

        function formatDetailedEventInfo(eventType, details) {
            if (!details || Object.keys(details).length === 0) {
                return '<div class="no-data">No detailed information available</div>';
            }

            let html = '<div class="details-grid">';

            if (eventType === 'login') {
                html += `
                    <div class="detail-row">
                        <span class="detail-label">Username:</span>
                        <span class="detail-value">${details.username || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Source IP:</span>
                        <span class="detail-value">${details.src_ip || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Authentication Status:</span>
                        <span class="detail-value status-${details.status?.toLowerCase()}">${details.status || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Device ID:</span>
                        <span class="detail-value">${details.device_id || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Auth Method:</span>
                        <span class="detail-value">${details.auth_method || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Admin Account:</span>
                        <span class="detail-value ${details.is_admin ? 'text-danger' : ''}">${details.is_admin ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Suspicious IP:</span>
                        <span class="detail-value ${details.is_suspicious_ip ? 'text-danger' : ''}">${details.is_suspicious_ip ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Burst Failure:</span>
                        <span class="detail-value ${details.is_burst_failure ? 'text-danger' : ''}">${details.is_burst_failure ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                `;
            } else if (eventType === 'firewall') {
                html += `
                    <div class="detail-row">
                        <span class="detail-label">Source IP:</span>
                        <span class="detail-value">${details.src_ip || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination IP:</span>
                        <span class="detail-value">${details.dst_ip || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Port:</span>
                        <span class="detail-value">${details.port || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Protocol:</span>
                        <span class="detail-value">${details.protocol || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Action:</span>
                        <span class="detail-value action-${details.action?.toLowerCase()}">${details.action || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Port Scan:</span>
                        <span class="detail-value ${details.is_port_scan ? 'text-danger' : ''}">${details.is_port_scan ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Lateral Movement:</span>
                        <span class="detail-value ${details.is_lateral_movement ? 'text-danger' : ''}">${details.is_lateral_movement ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Malicious Range:</span>
                        <span class="detail-value ${details.is_malicious_range ? 'text-danger' : ''}">${details.is_malicious_range ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Connection Spike:</span>
                        <span class="detail-value ${details.is_connection_spike ? 'text-danger' : ''}">${details.is_connection_spike ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                `;
            } else if (eventType === 'patch') {
                html += `
                    <div class="detail-row">
                        <span class="detail-label">Device ID:</span>
                        <span class="detail-value">${details.device_id || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Operating System:</span>
                        <span class="detail-value">${details.os || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Patch Date:</span>
                        <span class="detail-value">${details.last_patch_date ? new Date(details.last_patch_date).toLocaleDateString() : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Missing Critical Patches:</span>
                        <span class="detail-value ${details.missing_critical > 0 ? 'text-danger' : ''}">${details.missing_critical || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Missing High Patches:</span>
                        <span class="detail-value ${details.missing_high > 0 ? 'text-warning' : ''}">${details.missing_high || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Update Failures:</span>
                        <span class="detail-value ${details.update_failures > 0 ? 'text-warning' : ''}">${details.update_failures || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Unsupported OS:</span>
                        <span class="detail-value ${details.is_unsupported ? 'text-danger' : ''}">${details.is_unsupported ? 'Yes ‚ö†Ô∏è' : 'No'}</span>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // Load case details on page load
        loadCaseDetails();
    </script>
</body>
</html>
