<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>492-Energy-Defense Security Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="logo">
                <h2>üõ°Ô∏è Energy Defense</h2>
                <p class="subtitle">Security Operations Center</p>
            </div>
            <nav class="nav-menu">
                <a href="/" class="nav-item active">
                    <span class="nav-icon">üö®</span>
                    <span>Alerts & Anomalies</span>
                </a>
                <a href="/static/case-review.html" class="nav-item">
                    <span class="nav-icon">üìã</span>
                    <span>Case Review</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <p class="small-text">492-Energy-Defense</p>
                <p class="small-text">v2.0.0</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1>Alerts & Anomalies</h1>
                <div class="header-actions">
                    <button class="btn btn-refresh" onclick="loadData()">üîÑ Refresh</button>
                    <div class="last-update">Last updated: <span id="last-update">--</span></div>
                </div>
            </header>

            <!-- Stats Cards -->
            <section class="stats-grid">
                <div class="stat-card critical">
                    <div class="stat-icon">üî¥</div>
                    <div class="stat-content">
                        <h3 id="critical-count">--</h3>
                        <p>Critical Alerts</p>
                    </div>
                </div>
                <div class="stat-card high">
                    <div class="stat-icon">üü†</div>
                    <div class="stat-content">
                        <h3 id="high-count">--</h3>
                        <p>High Priority</p>
                    </div>
                </div>
                <div class="stat-card medium">
                    <div class="stat-icon">üü°</div>
                    <div class="stat-content">
                        <h3 id="medium-count">--</h3>
                        <p>Medium Priority</p>
                    </div>
                </div>
                <div class="stat-card total">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <h3 id="total-count">--</h3>
                        <p>Total Events (24h)</p>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <section class="filters">
                <div class="filter-group">
                    <label for="severity-filter">Severity:</label>
                    <select id="severity-filter" onchange="loadAlerts()">
                        <option value="">All</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="type-filter">Event Type:</label>
                    <select id="type-filter" onchange="loadAlerts()">
                        <option value="">All</option>
                        <option value="login">Login</option>
                        <option value="firewall">Firewall</option>
                        <option value="patch">Patch</option>
                    </select>
                </div>
            </section>

            <!-- Alerts List -->
            <section class="alerts-section">
                <h2>Recent Alerts</h2>
                <div id="alerts-container" class="alerts-container">
                    <!-- Alerts will be loaded here -->
                    <div class="loading">Loading alerts...</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Load dashboard data
        async function loadData() {
            await Promise.all([loadStats(), loadAlerts()]);
            updateLastUpdateTime();
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('critical-count').textContent = stats.critical_alerts;
                document.getElementById('high-count').textContent = stats.high_alerts;
                document.getElementById('medium-count').textContent = stats.medium_alerts;
                document.getElementById('total-count').textContent = stats.events_last_24h;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadAlerts() {
            const container = document.getElementById('alerts-container');
            container.innerHTML = '<div class="loading">Loading alerts...</div>';

            try {
                const severity = document.getElementById('severity-filter').value;
                const eventType = document.getElementById('type-filter').value;
                
                let url = '/api/alerts?limit=50';
                if (severity) url += `&severity=${severity}`;
                if (eventType) url += `&event_type=${eventType}`;

                const response = await fetch(url);
                const alerts = await response.json();

                if (alerts.length === 0) {
                    container.innerHTML = '<div class="no-data">No alerts found</div>';
                    return;
                }

                container.innerHTML = '';
                alerts.forEach(alert => {
                    const alertCard = createAlertCard(alert);
                    container.appendChild(alertCard);
                });
            } catch (error) {
                console.error('Error loading alerts:', error);
                container.innerHTML = '<div class="error">Error loading alerts. Please try again.</div>';
            }
        }

        function createAlertCard(alert) {
            const card = document.createElement('div');
            card.className = `alert-card severity-${alert.severity}`;
            
            const eventTypeIcon = {
                'login': 'üîê',
                'firewall': 'üî•',
                'patch': 'üõ°Ô∏è'
            };

            const severityBadge = {
                'critical': '<span class="badge badge-critical">CRITICAL</span>',
                'high': '<span class="badge badge-high">HIGH</span>',
                'medium': '<span class="badge badge-medium">MEDIUM</span>',
                'low': '<span class="badge badge-low">LOW</span>'
            };

            const timestamp = new Date(alert.analyzed_at);
            const timeAgo = getTimeAgo(timestamp);

            card.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title">
                        <span class="alert-icon">${eventTypeIcon[alert.event_type]}</span>
                        <span class="alert-type">${alert.event_type.toUpperCase()}</span>
                        ${severityBadge[alert.severity]}
                        <span class="risk-score">Risk Score: ${alert.risk_score}</span>
                    </div>
                    <div class="alert-time">${timeAgo}</div>
                </div>
                <div class="alert-body">
                    <div class="alert-reasoning">
                        <strong>Analysis:</strong> ${alert.reasoning}
                    </div>
                    <div class="alert-action">
                        <strong>Recommended Action:</strong> ${alert.recommended_action}
                    </div>
                    <div class="alert-details">
                        ${formatEventDetails(alert.event_type, alert.event_details)}
                    </div>
                </div>
                <div class="alert-footer">
                    <button class="btn-small btn-view" onclick="viewDetails(${alert.id})">View Full Details</button>
                </div>
            `;

            return card;
        }

        function formatEventDetails(eventType, details) {
            if (!details || Object.keys(details).length === 0) return '';

            let html = '<div class="event-details-grid">';

            if (eventType === 'login') {
                html += `
                    <div class="detail-item"><strong>User:</strong> ${details.username || 'N/A'}</div>
                    <div class="detail-item"><strong>Source IP:</strong> ${details.src_ip || 'N/A'}</div>
                    <div class="detail-item"><strong>Status:</strong> <span class="status-${details.status?.toLowerCase()}">${details.status || 'N/A'}</span></div>
                    <div class="detail-item"><strong>Device:</strong> ${details.device_id || 'N/A'}</div>
                `;
            } else if (eventType === 'firewall') {
                html += `
                    <div class="detail-item"><strong>Source:</strong> ${details.src_ip || 'N/A'}</div>
                    <div class="detail-item"><strong>Destination:</strong> ${details.dst_ip || 'N/A'}</div>
                    <div class="detail-item"><strong>Port:</strong> ${details.port || 'N/A'}</div>
                    <div class="detail-item"><strong>Action:</strong> <span class="action-${details.action?.toLowerCase()}">${details.action || 'N/A'}</span></div>
                `;
            } else if (eventType === 'patch') {
                html += `
                    <div class="detail-item"><strong>Device:</strong> ${details.device_id || 'N/A'}</div>
                    <div class="detail-item"><strong>OS:</strong> ${details.os || 'N/A'}</div>
                    <div class="detail-item"><strong>Critical Patches:</strong> ${details.missing_critical || 0}</div>
                    <div class="detail-item"><strong>High Patches:</strong> ${details.missing_high || 0}</div>
                `;
            }

            html += '</div>';
            return html;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        function viewDetails(alertId) {
            window.location.href = `/static/case-review.html?id=${alertId}`;
        }

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);

        // Initial load
        loadData();
    </script>
</body>
</html>
